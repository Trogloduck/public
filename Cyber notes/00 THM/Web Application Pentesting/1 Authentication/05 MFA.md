https://tryhackme.com/room/multifactorauthentications

### Table of contents
- [[#Intro]]
- [[#Common Vulnerabilities]]
- [[#Practical 1 - OTP Leakage]]
- [[#Practical 2 - Insecure Coding]]
- [[#Practical 3 - Beating Auto-Logout]]

___
### Intro
[[#Table of contents|Back to the top]]

**MFA:** 2 or more of the following
- **Know:** password, PIN, answer to security question
- **Have:** phone with auth app, token, ...
- **Are:** biometrics --> NB: fingerprint / face scans not 100% match --> can't be used by itself

Bonus: **Do:** app analyzes user typing credentials, mouse movements, used to restrict bots (typically on registration page)

Types
- **TOTP** - Time-Based One-Time Passwords: changes every 30 seconds or so (auth app)
- **Push Notifications:** send login request to phone
- **SMS:** code sent via SMS, convenient but can be intercepted
- **Hardware Tokens:** YubiKeys, one-time passcode / NFC, works offline

**Conditional Access** may trigger MFA based on
- Location
- Time
- Behavior
- Device

___
### Common Vulnerabilities
[[#Table of contents|Back to the top]]

**Weak Generation Algorithm**
--> predictable OTP

**App Leaking 2FA Token**
App handles data poorly / has insecure API endpoints
*e.g. :* app triggers XHR request to endpoint, requesting OTP, XHR returns OTP in HTTP response

**Brute Force**
Unlimited guesses --> devs should implement rate limiting in the 2FA checking

**Evilginx**
Can be used in sophisticated phishing attacks, acting as MitM proxy that intercepts OTP

![[Pasted image 20260208104142.png]]

___
### Practical 1 - OTP Leakage
[[#Table of contents|Back to the top]]

In XHR (`XMLHttpRequest`) response
--> server-side validation, instead of returning just success/failure, it returns OTP

Walkthrough - http://mfa.thm/labs/first
1. Login page
2. Open Dev Tool > Network
3. Authenticate
	--> XHR > Response tab > token = OTP

___
### Practical 2 - Insecure Coding
[[#Table of contents|Back to the top]]

Improper session management, poor access control, incorrect 2FA implementation --> Bypass 2FA
--> cookie/session should be split in 2 parts: one for username-password verification, the second for OTP verification

Walkthrough - http://mfa.thm/labs/second
1. Login page
2. Authenticate
3. Go to http://mfa.thm/labs/second/dashboard

___
### Practical 3 - Beating Auto-Logout
[[#Table of contents|Back to the top]]

Sometimes failing 2FA reverts back to 1st authentication
- **Session Invalidation:** failing 2FA invalidates user session --> has to redo authentication from start
- **Rate-Limiting, Lockout Policies:** prevent brute-force
- **Security-Driven Redirection:** redirect user to login page after failed 2FA

--> **Automation:** speed, consistency (no manual mistake), recover from logouts, customize (more than ZAP or Burp for instance)

Walkthrough - http://mfa.thm/labs/third
1. Go through login process and notice OTP is a 4-digit number

2. Run [[mfa_exploit.py]] --> OTP '1337' is hardcoded in script, script will run until app responds with same OTP

3. Dev Tool > Storage > Replace PHPSESSID with value from script result