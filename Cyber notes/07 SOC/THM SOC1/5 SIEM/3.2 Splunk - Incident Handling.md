### Table of contents
- [[#Incident Handling Life Cycle]]
- [[#Context]]
- [[#Reconnaissance]]
- 

___
### Incident Handling Life Cycle
[[#Table of contents|Back to the top]]

1. **Preparation**
Requirements, policies, security controls to monitor (EDR/SIEM/IDS/IPS, etc.); hiring/training staff

2. **Detection & Analysis**
Alerts from security controls, investigating, threat hunting

3. **Containment, Eradication, Recovery**
Prevent incident from spreading: prevent spreading in network, isolate infected host, clear network from infection traces, regain control

4. **Post-Incident Activity -- Lessons Learned**
Identify vulnerabilities, improve (adding detection rules, training staff)

___
### Context
[[#Table of contents|Back to the top]]

https://tryhackme.com/room/splunk201

*imreallynotbatman.com has been defaced*

Investigate cyber attack into all 7 phases of [[2 Cyber Kill Chain|Cyber Kill Chain]]
NB: findings in one chain may map into another phase, not necessarily respecting the chain's order

- Reconnaissance
- Weaponization
- Delivery
- Exploitation
- Installation
- Command & Control
- Actions on Objectives

Logs ingested from `webserver/firewall/Suricata/Sysmon/etc`

| Log Source              | Description                                   |
| ----------------------- | --------------------------------------------- |
| **wineventlog**         | Windows Event logs                            |
| **winRegistry**         | Registry creation/modification/deletion etc.  |
| **XmlWinEventLog**      | sysmon event logs                             |
| **fortigate_utm  <br>** | Fortinet Firewall                             |
| **iis  <br>**           | IIS web server                                |
| **Nessus:scan  <br>**   | Nessus vulnerability scanner                  |
| **Suricata  <br>**      | Suricata IDS: triggered alerts, trigger cause |
| **stream:http  <br>**   | HTTP traffic                                  |
| **stream: DNS  <br>**   | DNS traffic                                   |
| **stream:icmp  <br>**   | ICMP traffic                                  |

___
### Reconnaissance
[[#Table of contents|Back to the top]]

Recon attempt against *imreallynotbatman.com*

**Search Query**: `index=botsv1 imreallynotbatman.com`

We want to identify an IP

$\rightarrow$ filter HTTP traffic: `sourcetype=stream:http`
	$\rightarrow$ examine `src_ip`
		40.80.148.42: 93.402% of traffic
		23.22.63.114

$\rightarrow$ click on 40.80.148.42 to append search query
	$\rightarrow$  look at interesting fields such as User-Agent, Post request, URIs, etc.

Validate scanning $\rightarrow$ Suricata (IDS has visibility on network-centric logs): `sourcetype=suricata`
\> more fields > 'alert' > inspect different kinds of alert fields available and tick them
\> `http_user_agent` > "acunetix" (well-known vulnerability scanner)

Web server IP: 192.168.250.70

___
### Exploitation
[[#Table of contents|Back to the top]]

**Stats function** to display # requests per IP: `index=botsv1 imreallynotbatman.com sourcetype=stream* | stats count(src_ip) as Requests by src_ip | sort - Requests`

Requests sent to web server (i.e. all inbound traffic): `index=botsv1 sourcetype=stream:http dest_ip="192.168.250.70"`
- 40.80.148.42 	17,546 	91.438% 	(remote)
- 23.22.63.114 	1,429 	7.447% 	(remote)
- 192.168.2.50 	214 	1.115%    (local)

http_method $\rightarrow$ which method is used to make the requests
- POST 	14,238 	70.408% 	
- GET 	5,976 	29.552% 	
- OPTIONS 	5 	0.025% 	
- CONNECT 	1 	0.005% 	
- PROPFIND 	1 	0.005% 	
- TRACE 	1 	0.005% 	

Most used method is POST $\rightarrow$ investigate traffic using this method
`index=botsv1 sourcetype=stream:http dest_ip="192.168.250.70" http_method=POST`
$\rightarrow$ only the remote IPs are responsible for the POST requests
$\rightarrow$ investigate `src_ip`, ´, `http_user_agent`, `uri`

Web server is using Joomla as CMS (Content Management Service) $\rightarrow$ `/joomla/administrator/index.php` admin login page

$\rightarrow$ investigate traffic coming into this specific page
`index=botsv1 imreallynotbatman.com sourcetype=stream:http dest_ip="192.168.250.70"  uri="/joomla/administrator/index.php"`

$\rightarrow$ `form_data` $\rightarrow$ look for brute-force attempts
`index=botsv1 sourcetype=stream:http dest_ip="192.168.250.70" http_method=POST uri="/joomla/administrator/index.php" | table _time uri src_ip dest_ip form_data`
$\rightarrow$ We see the attacker (23.22.63.114) has tried to log in as "admin" and has tried numerous passwords using an automated tool (very short time between attempts)


**Regex to extract username and passwd fields**

- Display only logs containing "username" and "passwd": `form_data=*username*passwd*`
- Regex to extract passwd: `rex field=form_data "passwd=(?<creds>\w+)"`

`index=botsv1 sourcetype=stream:http dest_ip="192.168.250.70" http_method=POST form_data=*username*passwd* | rex field=form_data "passwd=(?<creds>\w+)"  | table src_ip creds`
$\rightarrow$ displays all passwords tried

By including `http_user_agent` in our statistics, we can see most requests we done by user agent Python-urllib/2.7 $\rightarrow$ automation tool
One request was made manually through Mozilla, but why?

*After finding the right password using an automation tool on host 23.22.63.114, the adversary logged in manually on host 40.80.148.42*

___
### Installation
[[#Table of contents|Back to the top]]

